global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    environment: production
    cluster: microservices-prod

rule_files:
  - "alerts.yml"

scrape_configs:
  # ==================== MICROSERVICES ====================

  # API Gateway
  - job_name: 'api-gateway'
    static_configs:
      - targets: ['api-gateway:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: application
      - source_labels: [__meta_kubernetes_pod_label_color]
        target_label: deployment_color

  # Order Service
  - job_name: 'order-service'
    static_configs:
      - targets: ['order-service:8081']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: application
      - source_labels: [__meta_kubernetes_pod_label_color]
        target_label: deployment_color

  # Payment Service
  - job_name: 'payment-service'
    static_configs:
      - targets: ['payment-service:8083']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: application

  # Auth Service
  - job_name: 'auth-service'
    static_configs:
      - targets: ['auth-service:8082']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s

  # ==================== INFRASTRUCTURE ====================

  # Kubernetes Pods
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - action: replace
        source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        target_label: __address__
        regex: (.+)
      - action: replace
        target_label: kubernetes_namespace
        source_labels: [__meta_kubernetes_namespace]
      - action: replace
        target_label: kubernetes_pod_name
        source_labels: [__meta_kubernetes_pod_name]

  # Kubernetes Services
  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
    - role: service
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true

  # ==================== CUSTOM METRICS ====================

  # Business Metrics
  - job_name: 'business-metrics'
    static_configs:
      - targets: ['order-service:8081', 'payment-service:8083']
    metrics_path: '/actuator/metrics/business.*'
    scrape_interval: 30s
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'business_(orders|payments|events|users)_.*'
        action: keep

  # Security Metrics
  - job_name: 'security-metrics'
    static_configs:
      - targets: ['order-service:8081', 'payment-service:8083']
    metrics_path: '/actuator/metrics/security.*'
    scrape_interval: 60s

  # Circuit Breaker Metrics
  - job_name: 'circuit-breaker-metrics'
    static_configs:
      - targets: ['api-gateway:8080', 'order-service:8081', 'payment-service:8083']
    metrics_path: '/actuator/metrics/resilience4j_circuitbreaker_*'
    scrape_interval: 15s

  # Cache Metrics
  - job_name: 'cache-metrics'
    static_configs:
      - targets: ['order-service:8081', 'payment-service:8083']
    metrics_path: '/actuator/metrics/cache_*'
    scrape_interval: 30s

  # Kafka Metrics
  - job_name: 'kafka-metrics'
    static_configs:
      - targets: ['order-service:8081', 'payment-service:8083']
    metrics_path: '/actuator/metrics/kafka_*'
    scrape_interval: 30s
