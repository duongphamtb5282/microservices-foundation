apiVersion: v1
kind: ServiceAccount
metadata:
  name: ms-order-service-sa
  namespace: ms-order-service-prod
  labels:
    app: ms-order-service
    service: ms-order-service
    environment: production
    # EKS specific labels
    app.kubernetes.io/name: ms-order-service
    app.kubernetes.io/component: order-service
    app.kubernetes.io/part-of: microservices
    app.kubernetes.io/managed-by: eks
  annotations:
    # EKS IRSA annotation for IAM role association
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT-ID:role/ms-order-service-eks-role"
    # EKS specific annotations
    eks.amazonaws.com/audience: "sts.amazonaws.com"
    eks.amazonaws.com/sts-regional-endpoints: "true"
---
# IAM Policy document for Order Service service account
apiVersion: v1
kind: ConfigMap
metadata:
  name: ms-order-service-iam-policy
  namespace: ms-order-service-prod
  labels:
    app: ms-order-service
    type: iam-policy-document
data:
  policy.json: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents",
            "logs:DescribeLogStreams"
          ],
          "Resource": [
            "arn:aws:logs:*:*:log-group:/aws/eks/ms-order-service-prod/*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "secretsmanager:GetSecretValue",
            "secretsmanager:DescribeSecret"
          ],
          "Resource": [
            "arn:aws:secretsmanager:*:*:secret:order-service/*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "kms:Decrypt",
            "kms:DescribeKey"
          ],
          "Resource": [
            "arn:aws:kms:*:*:key/*"
          ],
          "Condition": {
            "StringEquals": {
              "kms:ViaService": "secretsmanager.*.amazonaws.com"
            }
          }
        }
      ]
    }
