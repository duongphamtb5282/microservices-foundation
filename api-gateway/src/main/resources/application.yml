server:
  port: 8080

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      # Global filters (applied to all routes)
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      routes:
        # ==================== AUTHENTICATION & AUTHORIZATION ====================

        # Auth Service Routes (Public)
        - id: auth-service-public
          uri: http://localhost:8082
          predicates:
            - Path=/api/v1/auth/login, /api/v1/auth/register, /api/v1/auth/refresh, /api/v1/auth/validate
          filters:
            - StripPrefix=1
            - RateLimiter=auth-public

        # Auth Service Routes (Protected)
        - id: auth-service-protected
          uri: http://localhost:8082
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=1
            - AuthenticationFilter
            - ApiKeyAuthenticationFilter
            - RateLimiter=auth-protected

        # ==================== ORDER MANAGEMENT ====================

        # Order Service V1 Routes (Protected)
        - id: order-service-v1
          uri: http://localhost:8081
          predicates:
            - Path=/api/v1/orders/**
          filters:
            - StripPrefix=1
            - AuthenticationFilter
            - ApiKeyAuthenticationFilter
            - RateLimiter=order-service
            - CircuitBreaker=order-service
            - AddRequestHeader=X-API-Version, 1.0

        # Order Service V2 Routes (Protected) - Enhanced Features
        - id: order-service-v2
          uri: http://localhost:8081
          predicates:
            - Path=/api/v2/orders/**
          filters:
            - StripPrefix=1
            - AuthenticationFilter
            - ApiKeyAuthenticationFilter
            - RateLimiter=order-service
            - CircuitBreaker=order-service
            - AddRequestHeader=X-API-Version, 2.0

        # Order Service V1 Health
        - id: order-service-v1-health
          uri: http://localhost:8081
          predicates:
            - Path=/api/v1/orders/health
          filters:
            - StripPrefix=1

        # Order Service V2 Health
        - id: order-service-v2-health
          uri: http://localhost:8081
          predicates:
            - Path=/api/v2/orders/health
          filters:
            - StripPrefix=1

        # Order Service Health
        - id: order-service-health
          uri: http://localhost:8081
          predicates:
            - Path=/actuator/health/**
          filters:
            - StripPrefix=0

        # ==================== PAYMENT PROCESSING ====================

        # Payment Service Routes (Protected)
        - id: payment-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/v1/payments/**
          filters:
            - StripPrefix=1
            - AuthenticationFilter
            - ApiKeyAuthenticationFilter
            - RateLimiter=payment-service
            - CircuitBreaker=payment-service

        # Payment Service Health
        - id: payment-service-health
          uri: http://localhost:8083
          predicates:
            - Path=/actuator/health/**
          filters:
            - StripPrefix=0

        # ==================== BACKWARD COMPATIBILITY ====================

        # Legacy routes for existing services
        - id: comment-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/comments/**
          filters:
            - StripPrefix=1
            - AuthenticationFilter
            - RateLimiter=comment-service

        # ==================== API DOCUMENTATION ====================

        # Swagger UI Aggregation
        - id: swagger-ui
          uri: http://localhost:8081
          predicates:
            - Path=/swagger-ui/**
          filters:
            - StripPrefix=0

        # OpenAPI Specs
        - id: openapi-order
          uri: http://localhost:8081
          predicates:
            - Path=/v3/api-docs/order
          filters:
            - RewritePath=/v3/api-docs/order, /v3/api-docs

        - id: openapi-payment
          uri: http://localhost:8083
          predicates:
            - Path=/v3/api-docs/payment
          filters:
            - RewritePath=/v3/api-docs/payment, /v3/api-docs

        # ==================== MONITORING & OBSERVABILITY ====================

        # Gateway Health
        - id: gateway-health
          uri: http://localhost:8080
          predicates:
            - Path=/actuator/health/gateway
          filters:
            - RewritePath=/actuator/health/gateway, /actuator/health

        # Prometheus Metrics
        - id: gateway-metrics
          uri: http://localhost:8080
          predicates:
            - Path=/actuator/prometheus
          filters:
            - StripPrefix=0

        # Circuit Breaker Events
        - id: circuitbreaker-events
          uri: http://localhost:8080
          predicates:
            - Path=/actuator/circuitbreakerevents/**
          filters:
            - StripPrefix=0

  # ==================== FILTER CONFIGURATIONS ====================

  # Rate Limiting Configuration
  redis:
    rate-limiter:
      enabled: true

  # Custom Filters
  gateway:
    filters:
      authentication:
        enabled: true
        token-validation-url: http://localhost:8082/api/v1/auth/validate
        exclude-paths: /api/v1/auth/login,/api/v1/auth/register,/actuator/**
      api-key:
        enabled: true
        header: X-API-Key
        exclude-paths: /actuator/**,/swagger-ui/**,/v3/api-docs/**
        service-validation-url: http://localhost:8082/api/v1/auth/validate-api-key

# Resilience4j Configuration (Rate Limiting & Circuit Breaker)
resilience4j:
  ratelimiter:
    instances:
      auth-public:
        limit-for-period: 10
        limit-refresh-period: 1s
        timeout-duration: 0s
      auth-protected:
        limit-for-period: 100
        limit-refresh-period: 1s
        timeout-duration: 0s
      order-service:
        limit-for-period: 50
        limit-refresh-period: 1s
        timeout-duration: 0s
      payment-service:
        limit-for-period: 20
        limit-refresh-period: 1s
        timeout-duration: 0s
      comment-service:
        limit-for-period: 30
        limit-refresh-period: 1s
        timeout-duration: 0s

  circuitbreaker:
    instances:
      order-service:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      payment-service:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always

logging:
  level:
    com.pacific.gateway: INFO
    org.springframework.cloud.gateway: DEBUG
