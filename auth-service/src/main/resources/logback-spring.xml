<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Import Spring Boot default logback configuration -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <!-- Console appender with immediate flush disabled for better performance -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>
                %clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(%5p) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n%wEx
            </pattern>
            <immediateFlush>false</immediateFlush>
        </encoder>
    </appender>
    
    <!-- File appender with buffering -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE:-logs/application.log}</file>
        <encoder>
            <pattern>
                {"timestamp":"%d{yyyy-MM-dd HH:mm:ss.SSS}","level":"%level","logger":"%logger{36}","thread":"%thread","message":"%replace(%m){'[\r\n]+', ' '}","exception":"%replace(%replace(%ex){'[\r\n]+','\\n'}){'[\t]+',' '}%nopex"}
            </pattern>
            <immediateFlush>false</immediateFlush>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE:-logs/application.log}-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>${LOG_FILE_MAX_SIZE:-10MB}</maxFileSize>
            <maxHistory>${LOG_FILE_MAX_HISTORY:-30}</maxHistory>
            <totalSizeCap>${LOG_FILE_TOTAL_SIZE_CAP:-1GB}</totalSizeCap>
        </rollingPolicy>
    </appender>
    
    <!-- JSON appender with buffering -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_JSON_FILE:-logs/application.json}</file>
        <encoder>
            <pattern>
                {"timestamp":"%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ}","level":"%level","logger":"%logger{36}","thread":"%thread","message":"%replace(%m){'[\r\n]+', ' '}","exception":"%replace(%replace(%ex){'[\r\n]+','\\n'}){'[\t]+',' '}%nopex","hostname":"${HOSTNAME:-unknown}","application":"${spring.application.name:-unknown}"}
            </pattern>
            <immediateFlush>false</immediateFlush>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_JSON_FILE:-logs/application.json}-%d{yyyy-MM-dd}.%i.json.gz</fileNamePattern>
            <maxFileSize>${LOG_FILE_MAX_SIZE:-10MB}</maxFileSize>
            <maxHistory>${LOG_FILE_MAX_HISTORY:-30}</maxHistory>
            <totalSizeCap>${LOG_FILE_TOTAL_SIZE_CAP:-1GB}</totalSizeCap>
        </rollingPolicy>
    </appender>
    
    <!-- Async appender for better performance - OPTIMIZED -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
        <maxFlushTime>5000</maxFlushTime>
    </appender>
    
    <!-- Async JSON appender - OPTIMIZED -->
    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="JSON_FILE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
        <maxFlushTime>5000</maxFlushTime>
    </appender>
    
    <!-- Async console appender for development -->
    <appender name="ASYNC_CONSOLE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="CONSOLE"/>
        <queueSize>256</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
    </appender>
    
    <!-- Profile-specific configurations -->
    <springProfile name="dev,test">
        <!-- Development and test profiles -->
        <root level="INFO">
            <appender-ref ref="ASYNC_CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
        </root>
        
        <logger name="com.demo" level="DEBUG"/>
        <logger name="org.springframework.security" level="DEBUG"/>
        <logger name="org.hibernate.SQL" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="stg">
        <!-- Staging profile -->
        <root level="INFO">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_JSON"/>
        </root>
        
        <logger name="com.demo" level="DEBUG"/>
        <logger name="org.springframework.security" level="INFO"/>
    </springProfile>
    
    <springProfile name="prod">
        <!-- Production profile - minimal logging for best performance -->
        <root level="WARN">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_JSON"/>
        </root>
        
        <logger name="com.demo" level="INFO"/>
        <logger name="org.springframework.security" level="WARN"/>
    </springProfile>
    
    <!-- Common loggers - optimized levels -->
    <logger name="org.springframework.web" level="WARN"/>
    <logger name="org.springframework.security" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="org.hibernate.SQL" level="WARN"/>
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="WARN"/>
    <logger name="com.zaxxer.hikari" level="WARN"/>
    <logger name="org.apache.catalina" level="WARN"/>
    <logger name="org.apache.coyote" level="WARN"/>
    <logger name="org.apache.tomcat" level="WARN"/>
    <logger name="org.springframework.boot.actuate" level="WARN"/>
    <logger name="org.springframework.cache" level="WARN"/>
    <logger name="org.springframework.data" level="WARN"/>
    <logger name="org.flywaydb" level="WARN"/>
    <logger name="io.lettuce" level="WARN"/>
    <logger name="redis.clients" level="WARN"/>
    
    <!-- Disable noisy loggers -->
    <logger name="org.springframework.boot.autoconfigure" level="ERROR"/>
    <logger name="org.springframework.boot.context" level="ERROR"/>
    <logger name="_org.springframework.web.servlet.HandlerMapping.Mappings" level="ERROR"/>
</configuration>
